import { errorResponse, handleOptions, jsonResponse } from '../../_lib/http';
import { getServiceSupabaseClient, type SupabaseEnv } from '../../_lib/supabase';

interface EnvBindings extends SupabaseEnv {}

export const onRequest = async ({ request, env }: { request: Request; env: EnvBindings }) => {
  if (request.method === 'OPTIONS') {
    return handleOptions(request);
  }

  if (request.method !== 'GET') {
    return errorResponse(request, 405, 'Method Not Allowed');
  }

  try {
    const supabase = getServiceSupabaseClient(env);

    // Fetch only active stock sources for public consumption
    const { data: sources, error } = await supabase
      .from('stock_sources')
      .select('key, name, cost, active')
      .eq('active', true)
      .order('cost', { ascending: true })
      .order('name', { ascending: true });

    if (error) {
      throw new Error(error.message || 'Failed to fetch stock sources');
    }

    // Format the response to match the expected structure
    const sites = (sources || []).map((source: any) => ({
      key: source.key,
      name: source.name,
      cost: source.cost,
      active: source.active,
      iconUrl: `https://nehtw.com/assets/icons/${source.key}.png`,
    }));

    return jsonResponse(request, 200, { sites });
  } catch (error: any) {
    const message = error?.message || 'Unable to fetch stock sources';
    return errorResponse(request, 500, message);
  }
};